# scModelForge Recipe: Perturbation Prediction (Fine-tuning)
#
# Fine-tune a pretrained model to predict gene expression changes
# after perturbation. Uses scGPT-style binned expression tokenization
# with a regression head predicting top differentially expressed genes.
#
# Usage:
#   scmodelforge finetune \
#     --config configs/recipes/perturbation_prediction.yaml \
#     --checkpoint path/to/pretrained.ckpt
#
# Customize:
#   1. Set data.paths to your perturbation .h5ad file
#   2. Set finetune.label_key to the perturbation label column
#   3. Adjust finetune.head.output_dim to match your DEG count

data:
  source: local
  paths:
    - ./data/perturbation_dataset.h5ad  # Replace with your perturbation .h5ad
  gene_vocab: human_protein_coding
  preprocessing:
    normalize: library_size
    target_sum: 10000
    log1p: true
  max_genes: 2048
  num_workers: 4
  perturbation:
    enabled: true                     # Enable perturbation-aware data handling
    # perturbation_key: null          # Auto-detected from obs columns
    control_label: control

tokenizer:
  strategy: binned_expression         # scGPT-style: discretize expression into bins
  max_genes: 2048
  gene_vocab: human_protein_coding
  prepend_cls: true
  n_bins: 51                          # Number of expression bins
  binning_method: uniform
  masking:
    mask_ratio: 0.15
    random_replace_ratio: 0.1
    keep_ratio: 0.1

model:
  architecture: transformer_encoder
  hidden_dim: 512
  num_layers: 6
  num_heads: 8
  dropout: 0.1
  max_seq_len: 2048
  pooling: cls
  activation: gelu
  use_expression_values: true
  pretraining_task: masked_gene_prediction

training:
  batch_size: 32
  max_epochs: 30                      # More epochs for regression tasks
  seed: 42
  precision: bf16-mixed
  optimizer:
    name: adamw
    lr: 1.0e-4                        # Slightly higher LR for regression
    weight_decay: 0.01
  scheduler:
    name: cosine_warmup
    warmup_steps: 500
    total_steps: 15000
  gradient_clip: 1.0
  logger: wandb
  wandb_project: scmodelforge
  run_name: perturbation-prediction
  log_every_n_steps: 20
  checkpoint_dir: ./checkpoints/perturbation
  save_top_k: 3
  num_workers: 4
  val_split: 0.1

finetune:
  label_key: perturbation             # obs column with perturbation labels
  freeze_backbone: true
  freeze_backbone_epochs: 3           # Shorter freeze for regression
  head:
    task: regression
    output_dim: 50                    # Predict top 50 DEG expression changes
    hidden_dim: 256
    dropout: 0.1

eval:
  every_n_epochs: 5
  benchmarks:
    - name: perturbation
      dataset: perturbation_data
      params:
        perturbation_key: perturbation
        control_label: control
        n_top_genes: 50
